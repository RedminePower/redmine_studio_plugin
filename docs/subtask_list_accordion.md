# Subtask List Accordion

チケットの子チケット一覧にアコーディオン（折りたたみ/展開）機能を追加します。

## 概要

Redmine の子チケット一覧は、階層が深くなると全体を把握しにくくなります。
この機能は、子チケット一覧を「折りたたみ」や「展開」ができるアコーディオン形式に変換し、複雑なチケット構造でも必要な部分だけを表示して作業できるようにします。

<img src="images/subtask_list_accordion_01.png" width="700">

### 主な機能

- 子チケット一覧の各階層を折りたたみ/展開可能
- 子チケット一覧の上部に「すべて展開」「すべて収縮」リンクを追加
- 右クリックメニューから操作可能

### 動作条件

孫チケット（子チケットの子チケット）が存在する場合にのみ、アコーディオン機能が有効になります。
子チケットのみの場合は、通常の子チケット一覧が表示されます。

## プラグイン設定

管理者メニューの「プラグイン」→「Redmine Studio Plugin」から設定できます。

| 設定項目 | デフォルト値 | 説明 |
|----------|-------------|------|
| サーバー処理モードを有効にする | 有効 | 子チケット一覧の HTML をサーバー側で生成するモード |
| デフォルトですべての子チケットを展開する | 無効 | 初回表示時にすべての子チケットを展開するかどうか |
| 収縮させるトラッカー | なし | 指定したトラッカーのチケットはデフォルトで折りたたむ |

### サーバー処理モードとクライアント処理モード

本機能には2つの動作モードがあります。

| モード | 特徴 |
|--------|------|
| サーバー処理モード | 子チケット一覧の HTML をサーバー側で生成。大量の孫チケットがある場合でも高速に表示 |
| クライアント処理モード | Redmine 標準の子チケット一覧を JavaScript で加工。他のプラグインとの互換性が高い |

**モードの選択基準:**

- **サーバー処理モード（推奨）**: 子チケット一覧に関する他のプラグインを使用していない場合
- **クライアント処理モード**: `subtask_list_columns` など、子チケット一覧をカスタマイズするプラグインと併用する場合

### 収縮させるトラッカー

「デフォルトですべての子チケットを展開する」が有効な場合のみ設定できます。

指定したトラッカーのチケットは、すべて展開の設定に関わらず、デフォルトで折りたたんだ状態で表示されます。
これにより、特定のトラッカー（例：タスク、バグ）を折りたたみ、重要なトラッカー（例：機能、マイルストーン）は展開した状態で表示できます。

## ユーザー設定

各ユーザーが「個人設定」から設定できます。

| 設定項目 | デフォルト値 | 説明 |
|----------|-------------|------|
| デフォルトでツリーを展開する時の子チケット数上限 | 0 | 子チケット数がこの値以下の場合、自動的にツリーを展開 |

> **注意:** プラグイン設定の「デフォルトですべての子チケットを展開する」が有効な場合、このユーザー設定は無視されます。

### 動作例

- **上限値: 0** → 常に折りたたんだ状態で表示
- **上限値: 10** → 子チケットが 10 件以下なら展開、11 件以上なら折りたたみ
- **上限値: 999** → ほぼ常に展開した状態で表示

## 操作方法

### 子チケット一覧上部のリンク

子チケット一覧の上部に以下のリンクが表示されます。

| リンク | 動作 |
|--------|------|
| すべて展開 | すべての子チケットを展開 |
| すべて収縮 | すべての子チケットを折りたたみ、直下の子チケットのみ表示 |

### 右クリックメニュー

子チケット一覧でチケットを右クリックすると、以下のメニューが表示されます。

| メニュー項目 | 動作 |
|-------------|------|
| このツリーを展開 | 選択したチケットの配下をすべて展開 |
| このツリーを収縮 | 選択したチケットの配下をすべて折りたたみ |
| この階層をすべて展開 | 選択したチケットと同じ階層のチケットをすべて展開 |

### 折りたたみ/展開の操作

各チケットの左側にある矢印をクリックすると、そのチケットの子チケットを折りたたみ/展開できます。

- **▶（右向き矢印）**: クリックで展開
- **▼（下向き矢印）**: クリックで折りたたみ
