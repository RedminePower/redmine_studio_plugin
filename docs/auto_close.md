# Auto Close

特定のトリガーで、該当チケットに対して、自動的にアクションを行う機能です。

## 概要

以下の2種類のトリガーをサポートしています：

| トリガー | 動作 |
|---------|------|
| 全子チケット終了時 | 親チケットの全ての子チケットが終了されたときに、親チケットに対してアクションを実行 |
| 期限切れ時 | 期限日を過ぎたチケットを定期的にチェックし、条件に一致するチケットに対してアクションを実行（cron で毎日 3:00 に実行） |

実行可能なアクション：
- ステータス変更
- 担当者変更
- コメント追加

### ユースケース

**全子チケット終了時:**
- 親チケットを複数のサブタスクに分解し、すべて完了したら親を自動で終了
- リリースチケット配下の機能追加・バグ修正がすべて完了したら、リリースを自動で終了
- [Redmine Studio](https://www.redmine-power.com/) のレビュー機能と連携し、レビュー依頼・指摘がすべて終了したら、レビュー開催チケットを自動で終了

**期限切れ時:**
- 放置チケットの整理 - 期限を過ぎても対応されないチケットを自動で終了し、チケット一覧をクリーンに保つ
- 期限超過時のエスカレーション - 期限切れチケットの担当者を上長や管理者に変更し、対応を促進
- 対応漏れの防止 - 期限切れチケットにリマインドコメントを追加し、関係者に注意喚起

## 管理画面

管理者メニューの「自動クローズ」からルールの作成・編集・削除ができます。

## 設定項目

### 基本設定

| 項目 | 説明 |
|------|------|
| タイトル | 管理上わかりやすい名前を設定（必須） |
| 有効 | ルールの有効/無効を切り替え |
| プロジェクト | 適用対象のプロジェクトを選択（複数選択可）。未指定の場合はプロジェクトによる絞り込みなし |

### トリガー設定

| 項目 | 説明 |
|------|------|
| トリガー種類 | 「全子チケット終了時」または「期限切れ時」を選択（必須） |
| トラッカー | 対象チケットのトラッカーを指定。未指定の場合はトラッカーによる絞り込みなし |
| 題名のパターン | チケットの題名を正規表現で指定（例: `機能追加\|バグ`）。未指定の場合は題名による絞り込みなし |
| ステータス | 対象チケットのステータスを指定。未指定の場合はステータスによる絞り込みなし |
| カスタムフィールド | 真偽値型のカスタムフィールドで絞り込み。未指定の場合はカスタムフィールドによる絞り込みなし |
| 値 | 上記カスタムフィールドの条件値（チェック有り/無し） |

#### 期限切れトリガー専用の設定

| 項目 | 説明 |
|------|------|
| 一度に処理する最大件数 | 意図しない大量更新を防止するための上限値（デフォルト: 50）。対象件数がこの値を超えた場合、処理は実行されない |

> **注意:** 期限切れトリガーでは、少なくとも1つの条件（プロジェクト、トラッカー、ステータス、題名パターン、カスタムフィールド）を設定する必要があります。

### アクション設定

| 項目 | 説明 |
|------|------|
| ステータスを変更 | アクション実行時に変更するステータス |
| 担当者を変更 | アクション実行時に変更する担当者（ユーザーを直接指定） |
| カスタムフィールドで指定 | 担当者をユーザー型カスタムフィールドから取得。「担当者を変更」でユーザーが指定されている場合はそちらが優先 |
| コメントを追加 | アクション実行時に追加するコメント |
| 親チケットにも追加 | コメントを親チケットにも追加する |

> **注意:** 「ステータスを変更」「担当者を変更」「コメントを追加」のいずれか1つ以上を設定する必要があります。

#### 期限切れトリガー専用の設定

| 項目 | 説明 |
|------|------|
| 実行ユーザー | アクション実行時のユーザー（チケットの履歴に記録される） |

実行ユーザーの選択肢：

| 選択肢 | 説明 |
|--------|------|
| 対象チケットの担当者 | 対象チケットの現在の担当者として実行 |
| 対象チケットの作成者 | 対象チケットの作成者として実行 |
| 親チケットの担当者 | 親チケットの担当者として実行 |
| （ユーザー名） | 指定したユーザーとして実行 |

## 期限切れチケットの手動実行

期限切れトリガーは cron で毎日 3:00 に自動実行されますが、手動で実行する場合は以下のコマンドを使用します。

```bash
bundle exec rake redmine_studio_plugin:auto_close:check_expired RAILS_ENV=production
```

実行ログは `log/auto_close.log` に出力されます（詳細は `log/production.log` を確認）。
