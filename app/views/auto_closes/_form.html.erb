<%= javascript_tag do %>
  $(function() {
    function updateExpiredVisibility() {
      if ($("#auto_close_trigger_type").val() === "expired") {
        $("#auto_close_action_user_area").show();
        $("#auto_close_action_user_separator").show();
        $("#auto_close_max_issues_area").show();
        $("#auto_close_expired_warning").show();
      } else {
        $("#auto_close_action_user_area").hide();
        $("#auto_close_action_user_separator").hide();
        $("#auto_close_max_issues_area").hide();
        $("#auto_close_expired_warning").hide();
      }
    }

    <%# 初期表示 %>
    updateExpiredVisibility();

    <%# トリガー種類が変更されたら、動的に表示/非表示を切り替える %>
    $("#auto_close_trigger_type").change(function() {
      updateExpiredVisibility();
    });
  });
<% end %>

<%= error_messages_for 'auto_close' %>

<div class="box tabular">
  <%# タイトル %>
  <p>
    <%= form.text_field :title,
        :size => 100,
        :required => true,
        :disabled => (disabled || false)  %>
    <em class="info">
      <%= l(:text_title_info) %>
    </em>
  </p>
  <%# 有効 %>
  <p>
    <%= form.check_box :is_enabled,
        :disabled => (disabled || false) %>
  </p>
  <%# プロジェクト %>
  <p>
    <%= form.select :project_ids,
          options_for_select(
            [""] + Project.all.map{|t| [t.name, t.id]},
            :selected => @auto_close.project_ids),
          {},
          :multiple => true,
          :size => 10,
          :disabled => (disabled || false) %>
    <em class="info">
      <%= l(:text_project_ids_info) %><br />
      <%= l(:text_project_ids_notset_info) %>
    </em>
  </p>
  <%# ******************************* %>
  <%# トリガー                          %>
  <%# ******************************* %>
  <%= field_set_tag l(:label_trigger) do %>
    <%# トリガー種類 %>
    <%# disabled と required を、二つ指定すると動作しなくなってしまったので、disabled を優先した。 %>
    <p>
      <%= form.select :trigger_type,
            options_for_select(
              @auto_close.trigger_types.map {|key, val| [l(key), val]},
              :selected => @auto_close.trigger_type),
            {},
            :disabled => (disabled ? true : false) %>
    </p>
    <%# 期限切れトリガーの警告メッセージ %>
    <div id="auto_close_expired_warning" class="warning" style="display: none; padding: 10px; margin: 10px 0; background-color: #ffeeba; border: 1px solid #ffc107; border-radius: 4px;">
      <%= l(:warning_expired_trigger) %>
    </div>
    <%# 一度に処理する最大件数（期限切れトリガー用） %>
    <p id="auto_close_max_issues_area" style="display: none;">
      <%= form.number_field :max_issues_per_run,
          :min => 1,
          :required => true,
          :disabled => (disabled || false) %>
      <em class="info">
        <%= l(:text_max_issues_per_run_info) %>
      </em>
    </p>
    <%# トラッカー %>
    <p>
      <%= form.select :trigger_tracker,
            options_for_select(
              [""] + Tracker.all.map{|t| [t.name, t.id]},
              :selected => @auto_close.trigger_tracker),
              {},
              :disabled => (disabled || false) %>
      <em class="info">
        <%= l(:text_trigger_tracker_info) %><br />
        <%= l(:text_trigger_tracker_notset_info) %>
      </em>
    </p>
    <%# 題名 %>
    <p>
      <%= form.text_field :trigger_subject_pattern,
          :size => 100,
          :disabled => (disabled || false) %>
      <em class="info">
        <%= l(:text_trigger_subject_pattern_info) %><br />
        <%= l(:text_trigger_subject_pattern_notset_info) %>
      </em>
    </p>
    <%# ステータス %>
    <p>
      <%= form.select :trigger_status,
            options_for_select(
              [""] + IssueStatus.all.map{|t| [t.name, t.id]},
              :selected => @auto_close.trigger_status),
              {},
              :disabled => (disabled || false) %>
      <em class="info">
        <%= l(:text_trigger_status_info) %><br />
        <%= l(:text_trigger_status_notset_info) %>
      </em>
    </p>
    <%# カスタムフィールド %>
    <p>
      <%= form.select :trigger_custom_field,
            options_for_select(
              [""] + @auto_close.bool_custom_fields.all.map{|t| [t.name, t.id]},
              :selected => @auto_close.trigger_custom_field),
              {},
              :disabled => (disabled || false) %>
    </p>
    <p>
      <%= form.check_box :trigger_custom_field_boolean,
      :disabled => (disabled || false) %>
      <em class="info">
        <%= l(:text_trigger_custom_field_info) %><br />
        <%= l(:text_trigger_custom_field_notset_info) %>
      </em>
    </p>
  <% end %><br />

  <%# ******************************* %>
  <%# アクション                       %>
  <%# ******************************* %>
  <%= field_set_tag l(:label_action) do %>
    <%# 実行ユーザー（期限切れトリガー用） %>
    <p id="auto_close_action_user_area" style="display: none;">
      <%= form.select :action_user,
            options_for_select(
              @auto_close.action_user_options,
              :selected => @auto_close.action_user),
              {},
              :disabled => (disabled || false) %>
      <em class="info">
        <%= l(:text_action_user_info) %>
      </em>
    </p>
    <hr id="auto_close_action_user_separator" style="display: none; height: 1px;">

    <%# ステータスを変更 %>
    <p>
      <%= form.select :action_status,
            options_for_select(
              [""] + IssueStatus.all.map{|t| [t.name, t.id]},
              :selected => @auto_close.action_status),
              {},
              :disabled => (disabled || false) %>
    </p>

    <%# 担当者を変更 %>
    <hr style="height: 1px;" >
    <p>
      <%= form.select :action_assigned_to,
            options_for_select(
              [""] + User.where(status: 1).collect{|u| [u.name,u.id]},
              :selected => @auto_close.action_assigned_to),
              {},
              :disabled => (disabled || false) %>
    </p>
    <p>
      <%= form.select :action_assigned_to_custom_field,
            options_for_select(
              [""] + @auto_close.user_custom_fields.all.map{|t| [t.name, t.id]},
              :selected => @auto_close.action_assigned_to_custom_field),
              {},
              :disabled => (disabled || false) %>
      <em class="info">
        <%= l(:text_action_assigned_to_custom_field_info) %><br />
        <%= l(:text_action_assigned_to_custom_field_info_2) %>
      </em>
    </p>

    <%# コメントを追加 %>
    <hr style="height: 1px;" >
    <p>
      <%= form.text_area :action_comment,
       :rows => 12,
       :disabled => (disabled || false) %>
    </p>
    <p>
      <%= form.check_box :is_action_comment_parent,
      :disabled => (disabled || false) %>
    </p>
  <% end %>
</div>